Bootstrap: docker
From: nvidia/cuda:12.1.1-devel-ubuntu22.04

%post
    export DEBIAN_FRONTEND=noninteractive

    # 1. Update and install all system dependencies in a single command.
    echo "--> Installing Python, Git, Build Tools, and CUDA Toolkit..."
    apt-get update && apt-get install -y --no-install-recommends \
        python3.10 \
        python3.10-venv \
        build-essential \
        git \
        nvidia-cuda-toolkit \
    && rm -rf /var/lib/apt/lists/*

    # 2. Create Python virtual environment
    echo "--> Creating Python virtual environment at /opt/venv..."
    python3.10 -m venv /opt/venv

    # 3. Install Python packages into the venv
    echo "--> Installing Python packages..."
    # Activate the venv to use its pip
    . /opt/venv/bin/activate

    pip install --no-cache-dir --upgrade pip
    pip install --no-cache-dir \
        'datasets==2.21.0' \
        'numpy==1.26.4' \
        'peft==0.10.0' \
        'torch==2.2.1' \
        'tqdm==4.66.3' \
        'transformers==4.45.2' \
        'deepspeed==0.14.4' \
        'accelerate==0.33.0'

%environment
    # Set up the environment to use Python from our venv
    export PATH="/opt/venv/bin:$PATH"
    export VIRTUAL_ENV="/opt/venv"
    export TOKENIZERS_PARALLELISM=false
    # Recommended: Point the Triton cache to the job's temporary directory
    if [ -n "$SLURM_JOB_ID" ]; then
        export TRITON_CACHE_DIR="/tmp/${USER}/${SLURM_JOB_ID}/triton_cache"
    fi

%runscript
    echo "Container is running. Python version from venv:"
    python3 --version