Bootstrap: docker
From: nvidia/cuda:12.1.1-devel-ubuntu22.04

%post
    export DEBIAN_FRONTEND=noninteractive

    # 1. Update and install system dependencies
    echo "--> Installing Python and Build Tools..."
    apt-get update && apt-get install -y --no-install-recommends \
        python3.10 \
        python3.10-venv \
        build-essential \
        git \
        # --- THIS IS THE FIX ---
        # Install the CUDA toolkit and compiler directly inside the image.
        nvidia-cuda-toolkit
        # --- END OF FIX ---
    && rm -rf /var/lib/apt/lists/*

    # 2. Create Python virtual environment
    echo "--> Creating Python virtual environment at /opt/venv..."
    python3.10 -m venv /opt/venv
    . /opt/venv/bin/activate

    # 3. Install Python packages
    echo "--> Installing Python packages..."
    pip install --no-cache-dir --upgrade pip
    pip install --no-cache-dir \
        'datasets==2.21.0' \
        'numpy==1.26.4' \
        'peft==0.10.0' \
        'torch==2.2.1' \
        'tqdm==4.66.3' \
        'transformers==4.45.2' \
        'deepspeed==0.14.4' \
        'accelerate==0.33.0'

%environment
    # The rest of the file is the same
    export PATH="/opt/venv/bin:$PATH"
    export VIRTUAL_ENV="/opt/venv"
    export TOKENIZERS_PARALLELISM=false
    if [ -n "$SLURM_JOB_ID" ]; then
        export TRITON_CACHE_DIR="/tmp/${USER}/${SLURM_JOB_ID}/triton_cache"
    fi

%runscript
    echo "Container is running. Python version from venv:"
    python3 --version